<!DOCTYPE html>
<html lang="en-US">
<head>
	<meta charset="UTF-8">
	<title>Logging to the database with ASP.NET Core | makolyte</title>
	<style>img:is([sizes="auto" i], [sizes^="auto," i]) { contain-intrinsic-size: 3000px 1500px }</style>
	<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The SEO Framework by Sybre Waaijer -->
<meta name="robots" content="max-snippet:-1,max-image-preview:standard,max-video-preview:-1">
<link rel="canonical" href="/aspdotnet-log-messages-to-the-database-in-the-background/">
<meta name="description" content="Shows the design and implementation for logging to the database asynchronously with a background service">
<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="makolyte">
<meta property="og:title" content="Logging to the database with ASP.NET Core | makolyte">
<meta property="og:description" content="Shows the design and implementation for logging to the database asynchronously with a background service">
<meta property="og:url" content="/aspdotnet-log-messages-to-the-database-in-the-background/">
<meta property="og:image" content="/wp-content/uploads/2021/08/cropped-background-database-logger.png">
<meta property="og:image:width" content="594">
<meta property="og:image:height" content="312">
<meta property="article:published_time" content="2021-08-14T13:24:59+00:00">
<meta property="article:modified_time" content="2024-06-11T11:58:15+00:00">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@makolyte">
<meta name="twitter:title" content="Logging to the database with ASP.NET Core | makolyte">
<meta name="twitter:description" content="Shows the design and implementation for logging to the database asynchronously with a background service">
<meta name="twitter:image" content="/wp-content/uploads/2021/08/cropped-background-database-logger.png">



<link rel="alternate" type="application/rss+xml" title="makolyte &raquo; Feed" href="/feed/">
<link rel="alternate" type="application/rss+xml" title="makolyte &raquo; Comments Feed" href="/comments/feed/">
<link rel="alternate" type="application/rss+xml" title="makolyte &raquo; Logging to the database with ASP.NET Core Comments Feed" href="/aspdotnet-log-messages-to-the-database-in-the-background/feed/">
<script>
window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/15.0.3\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/15.0.3\/svg\/","svgExt":".svg","source":{"concatemoji":"\/wp-includes\/js\/wp-emoji-release.min.js?ver=6.7.2"}};
/*! This file is auto-generated */
!function(i,n){var o,s,e;function c(e){try{var t={supportTests:e,timestamp:(new Date).valueOf()};sessionStorage.setItem(o,JSON.stringify(t))}catch(e){}}function p(e,t,n){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(t,0,0);var t=new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data),r=(e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(n,0,0),new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data));return t.every(function(e,t){return e===r[t]})}function u(e,t,n){switch(t){case"flag":return n(e,"üè≥Ô∏è‚Äç‚ößÔ∏è","üè≥Ô∏è‚Äã‚ößÔ∏è")?!1:!n(e,"üá∫üá≥","üá∫‚Äãüá≥")&&!n(e,"üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø","üè¥‚ÄãÛ†Åß‚ÄãÛ†Å¢‚ÄãÛ†Å•‚ÄãÛ†ÅÆ‚ÄãÛ†Åß‚ÄãÛ†Åø");case"emoji":return!n(e,"üê¶‚Äç‚¨õ","üê¶‚Äã‚¨õ")}return!1}function f(e,t,n){var r="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?new OffscreenCanvas(300,150):i.createElement("canvas"),a=r.getContext("2d",{willReadFrequently:!0}),o=(a.textBaseline="top",a.font="600 32px Arial",{});return e.forEach(function(e){o[e]=t(a,e,n)}),o}function t(e){var t=i.createElement("script");t.src=e,t.defer=!0,i.head.appendChild(t)}"undefined"!=typeof Promise&&(o="wpEmojiSettingsSupports",s=["flag","emoji"],n.supports={everything:!0,everythingExceptFlag:!0},e=new Promise(function(e){i.addEventListener("DOMContentLoaded",e,{once:!0})}),new Promise(function(t){var n=function(){try{var e=JSON.parse(sessionStorage.getItem(o));if("object"==typeof e&&"number"==typeof e.timestamp&&(new Date).valueOf()<e.timestamp+604800&&"object"==typeof e.supportTests)return e.supportTests}catch(e){}return null}();if(!n){if("undefined"!=typeof Worker&&"undefined"!=typeof OffscreenCanvas&&"undefined"!=typeof URL&&URL.createObjectURL&&"undefined"!=typeof Blob)try{var e="postMessage("+f.toString()+"("+[JSON.stringify(s),u.toString(),p.toString()].join(",")+"));",r=new Blob([e],{type:"text/javascript"}),a=new Worker(URL.createObjectURL(r),{name:"wpTestEmojiSupports"});return void(a.onmessage=function(e){c(n=e.data),a.terminate(),t(n)})}catch(e){}c(n=f(s,u,p))}t(n)}).then(function(e){for(var t in e)n.supports[t]=e[t],n.supports.everything=n.supports.everything&&n.supports[t],"flag"!==t&&(n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&n.supports[t]);n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&!n.supports.flag,n.DOMReady=!1,n.readyCallback=function(){n.DOMReady=!0}}).then(function(){return e}).then(function(){var e;n.supports.everything||(n.readyCallback(),(e=n.source||{}).concatemoji?t(e.concatemoji):e.wpemoji&&e.twemoji&&(t(e.twemoji),t(e.wpemoji)))}))}((window,document),window._wpemojiSettings);
</script>
<style id="wp-emoji-styles-inline-css">img.wp-smiley, img.emoji {
		display: inline !important;
		border: none !important;
		box-shadow: none !important;
		height: 1em !important;
		width: 1em !important;
		margin: 0 0.07em !important;
		vertical-align: -0.1em !important;
		background: none !important;
		padding: 0 !important;
	}</style>
<link rel="stylesheet" id="wp-block-library-css" href="/wp-includes/css/dist/block-library/style.min.css?ver=6.7.2" media="all">
<link rel="stylesheet" id="syntax-highlighting-code-block-theme-css" href="/wp-content/plugins/syntax-highlighting-code-block/vendor/scrivo/highlight-php/styles/vs2015.css?ver=1.5.1" media="all">
<style id="syntax-highlighting-code-block-inline-css">.wp-block-code {
	border: 0;
	padding: 0;
	-webkit-text-size-adjust: 100%;
	text-size-adjust: 100%;
}

.wp-block-code > span {
	display: block;
	overflow: auto;
}

.shcb-language {
	border: 0;
	clip: rect(1px, 1px, 1px, 1px);
	-webkit-clip-path: inset(50%);
	clip-path: inset(50%);
	height: 1px;
	margin: -1px;
	overflow: hidden;
	padding: 0;
	position: absolute;
	width: 1px;
	word-wrap: normal;
	word-break: normal;
}

.hljs {
	box-sizing: border-box;
}

.hljs.shcb-code-table {
	display: table;
	width: 100%;
}

.hljs.shcb-code-table > .shcb-loc {
	color: inherit;
	display: table-row;
	width: 100%;
}

.hljs.shcb-code-table .shcb-loc > span {
	display: table-cell;
}

.wp-block-code code.hljs:not(.shcb-wrap-lines) {
	white-space: pre;
}

.wp-block-code code.hljs.shcb-wrap-lines {
	white-space: pre-wrap;
}

.hljs.shcb-line-numbers {
	border-spacing: 0;
	counter-reset: line;
}

.hljs.shcb-line-numbers > .shcb-loc {
	counter-increment: line;
}

.hljs.shcb-line-numbers .shcb-loc > span {
	padding-left: 0.75em;
}

.hljs.shcb-line-numbers .shcb-loc::before {
	border-right: 1px solid #ddd;
	content: counter(line);
	display: table-cell;
	padding: 0 0.75em;
	text-align: right;
	-webkit-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
	user-select: none;
	white-space: nowrap;
	width: 1%;
}

.hljs > mark.shcb-loc { background-color: #3F3F3F; }</style>
<style id="classic-theme-styles-inline-css">/*! This file is auto-generated */
.wp-block-button__link{color:#fff;background-color:#32373c;border-radius:9999px;box-shadow:none;text-decoration:none;padding:calc(.667em + 2px) calc(1.333em + 2px);font-size:1.125em}.wp-block-file__button{background:#32373c;color:#fff;text-decoration:none}</style>
<style id="global-styles-inline-css">:root{--wp--preset--aspect-ratio--square: 1;--wp--preset--aspect-ratio--4-3: 4/3;--wp--preset--aspect-ratio--3-4: 3/4;--wp--preset--aspect-ratio--3-2: 3/2;--wp--preset--aspect-ratio--2-3: 2/3;--wp--preset--aspect-ratio--16-9: 16/9;--wp--preset--aspect-ratio--9-16: 9/16;--wp--preset--color--black: #000000;--wp--preset--color--cyan-bluish-gray: #abb8c3;--wp--preset--color--white: #ffffff;--wp--preset--color--pale-pink: #f78da7;--wp--preset--color--vivid-red: #cf2e2e;--wp--preset--color--luminous-vivid-orange: #ff6900;--wp--preset--color--luminous-vivid-amber: #fcb900;--wp--preset--color--light-green-cyan: #7bdcb5;--wp--preset--color--vivid-green-cyan: #00d084;--wp--preset--color--pale-cyan-blue: #8ed1fc;--wp--preset--color--vivid-cyan-blue: #0693e3;--wp--preset--color--vivid-purple: #9b51e0;--wp--preset--color--contrast: var(--contrast);--wp--preset--color--contrast-2: var(--contrast-2);--wp--preset--color--contrast-3: var(--contrast-3);--wp--preset--color--base: var(--base);--wp--preset--color--base-2: var(--base-2);--wp--preset--color--base-3: var(--base-3);--wp--preset--color--accent: var(--accent);--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple: linear-gradient(135deg,rgba(6,147,227,1) 0%,rgb(155,81,224) 100%);--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan: linear-gradient(135deg,rgb(122,220,180) 0%,rgb(0,208,130) 100%);--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange: linear-gradient(135deg,rgba(252,185,0,1) 0%,rgba(255,105,0,1) 100%);--wp--preset--gradient--luminous-vivid-orange-to-vivid-red: linear-gradient(135deg,rgba(255,105,0,1) 0%,rgb(207,46,46) 100%);--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray: linear-gradient(135deg,rgb(238,238,238) 0%,rgb(169,184,195) 100%);--wp--preset--gradient--cool-to-warm-spectrum: linear-gradient(135deg,rgb(74,234,220) 0%,rgb(151,120,209) 20%,rgb(207,42,186) 40%,rgb(238,44,130) 60%,rgb(251,105,98) 80%,rgb(254,248,76) 100%);--wp--preset--gradient--blush-light-purple: linear-gradient(135deg,rgb(255,206,236) 0%,rgb(152,150,240) 100%);--wp--preset--gradient--blush-bordeaux: linear-gradient(135deg,rgb(254,205,165) 0%,rgb(254,45,45) 50%,rgb(107,0,62) 100%);--wp--preset--gradient--luminous-dusk: linear-gradient(135deg,rgb(255,203,112) 0%,rgb(199,81,192) 50%,rgb(65,88,208) 100%);--wp--preset--gradient--pale-ocean: linear-gradient(135deg,rgb(255,245,203) 0%,rgb(182,227,212) 50%,rgb(51,167,181) 100%);--wp--preset--gradient--electric-grass: linear-gradient(135deg,rgb(202,248,128) 0%,rgb(113,206,126) 100%);--wp--preset--gradient--midnight: linear-gradient(135deg,rgb(2,3,129) 0%,rgb(40,116,252) 100%);--wp--preset--font-size--small: 13px;--wp--preset--font-size--medium: 20px;--wp--preset--font-size--large: 36px;--wp--preset--font-size--x-large: 42px;--wp--preset--spacing--20: 0.44rem;--wp--preset--spacing--30: 0.67rem;--wp--preset--spacing--40: 1rem;--wp--preset--spacing--50: 1.5rem;--wp--preset--spacing--60: 2.25rem;--wp--preset--spacing--70: 3.38rem;--wp--preset--spacing--80: 5.06rem;--wp--preset--shadow--natural: 6px 6px 9px rgba(0, 0, 0, 0.2);--wp--preset--shadow--deep: 12px 12px 50px rgba(0, 0, 0, 0.4);--wp--preset--shadow--sharp: 6px 6px 0px rgba(0, 0, 0, 0.2);--wp--preset--shadow--outlined: 6px 6px 0px -3px rgba(255, 255, 255, 1), 6px 6px rgba(0, 0, 0, 1);--wp--preset--shadow--crisp: 6px 6px 0px rgba(0, 0, 0, 1);}:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flex{display: flex;}.is-layout-flex{flex-wrap: wrap;align-items: center;}.is-layout-flex > :is(*, div){margin: 0;}body .is-layout-grid{display: grid;}.is-layout-grid > :is(*, div){margin: 0;}:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}.has-black-color{color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-color{color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-color{color: var(--wp--preset--color--white) !important;}.has-pale-pink-color{color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-color{color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-color{color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-color{color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-color{color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-color{color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-color{color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-color{color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-color{color: var(--wp--preset--color--vivid-purple) !important;}.has-black-background-color{background-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-background-color{background-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-background-color{background-color: var(--wp--preset--color--white) !important;}.has-pale-pink-background-color{background-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-background-color{background-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-background-color{background-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-background-color{background-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-background-color{background-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-background-color{background-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-background-color{background-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-background-color{background-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-background-color{background-color: var(--wp--preset--color--vivid-purple) !important;}.has-black-border-color{border-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-border-color{border-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-border-color{border-color: var(--wp--preset--color--white) !important;}.has-pale-pink-border-color{border-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-border-color{border-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-border-color{border-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-border-color{border-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-border-color{border-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-border-color{border-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-border-color{border-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-border-color{border-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-border-color{border-color: var(--wp--preset--color--vivid-purple) !important;}.has-vivid-cyan-blue-to-vivid-purple-gradient-background{background: var(--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple) !important;}.has-light-green-cyan-to-vivid-green-cyan-gradient-background{background: var(--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan) !important;}.has-luminous-vivid-amber-to-luminous-vivid-orange-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange) !important;}.has-luminous-vivid-orange-to-vivid-red-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-orange-to-vivid-red) !important;}.has-very-light-gray-to-cyan-bluish-gray-gradient-background{background: var(--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray) !important;}.has-cool-to-warm-spectrum-gradient-background{background: var(--wp--preset--gradient--cool-to-warm-spectrum) !important;}.has-blush-light-purple-gradient-background{background: var(--wp--preset--gradient--blush-light-purple) !important;}.has-blush-bordeaux-gradient-background{background: var(--wp--preset--gradient--blush-bordeaux) !important;}.has-luminous-dusk-gradient-background{background: var(--wp--preset--gradient--luminous-dusk) !important;}.has-pale-ocean-gradient-background{background: var(--wp--preset--gradient--pale-ocean) !important;}.has-electric-grass-gradient-background{background: var(--wp--preset--gradient--electric-grass) !important;}.has-midnight-gradient-background{background: var(--wp--preset--gradient--midnight) !important;}.has-small-font-size{font-size: var(--wp--preset--font-size--small) !important;}.has-medium-font-size{font-size: var(--wp--preset--font-size--medium) !important;}.has-large-font-size{font-size: var(--wp--preset--font-size--large) !important;}.has-x-large-font-size{font-size: var(--wp--preset--font-size--x-large) !important;}
:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}
:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}
:root :where(.wp-block-pullquote){font-size: 1.5em;line-height: 1.6;}</style>
<link rel="stylesheet" id="ez-toc-css" href="/wp-content/plugins/etoc-makolyte-mod/assets/css/screen.min.css?ver=2.0.17.1" media="all">
<style id="ez-toc-inline-css">div#ez-toc-container p.ez-toc-title {font-size: 120%;}div#ez-toc-container p.ez-toc-title {font-weight: 500;}div#ez-toc-container ul li {font-size: 95%;}</style>
<link rel="stylesheet" id="related-frontend-css-css" href="/wp-content/plugins/related/css/frontend-style.css?ver=3.5.0" media="all">
<link rel="stylesheet" id="generate-style-css" href="/wp-content/themes/generatepress/assets/css/all.min.css?ver=3.3.1" media="all">
<style id="generate-style-inline-css">body{background-color:#ffffff;color:#000000;}a{color:#1e73be;}a:hover, a:focus, a:active{color:#000000;}body .grid-container{max-width:1400px;}.wp-block-group__inner-container{max-width:1400px;margin-left:auto;margin-right:auto;}.navigation-search{position:absolute;left:-99999px;pointer-events:none;visibility:hidden;z-index:20;width:100%;top:0;transition:opacity 100ms ease-in-out;opacity:0;}.navigation-search.nav-search-active{left:0;right:0;pointer-events:auto;visibility:visible;opacity:1;}.navigation-search input[type="search"]{outline:0;border:0;vertical-align:bottom;line-height:1;opacity:0.9;width:100%;z-index:20;border-radius:0;-webkit-appearance:none;height:60px;}.navigation-search input::-ms-clear{display:none;width:0;height:0;}.navigation-search input::-ms-reveal{display:none;width:0;height:0;}.navigation-search input::-webkit-search-decoration, .navigation-search input::-webkit-search-cancel-button, .navigation-search input::-webkit-search-results-button, .navigation-search input::-webkit-search-results-decoration{display:none;}.main-navigation li.search-item{z-index:21;}li.search-item.active{transition:opacity 100ms ease-in-out;}.nav-left-sidebar .main-navigation li.search-item.active,.nav-right-sidebar .main-navigation li.search-item.active{width:auto;display:inline-block;float:right;}.gen-sidebar-nav .navigation-search{top:auto;bottom:0;}:root{--contrast:#222222;--contrast-2:#575760;--contrast-3:#b2b2be;--base:#f0f0f0;--base-2:#f7f8f9;--base-3:#ffffff;--accent:#1e73be;}:root .has-contrast-color{color:var(--contrast);}:root .has-contrast-background-color{background-color:var(--contrast);}:root .has-contrast-2-color{color:var(--contrast-2);}:root .has-contrast-2-background-color{background-color:var(--contrast-2);}:root .has-contrast-3-color{color:var(--contrast-3);}:root .has-contrast-3-background-color{background-color:var(--contrast-3);}:root .has-base-color{color:var(--base);}:root .has-base-background-color{background-color:var(--base);}:root .has-base-2-color{color:var(--base-2);}:root .has-base-2-background-color{background-color:var(--base-2);}:root .has-base-3-color{color:var(--base-3);}:root .has-base-3-background-color{background-color:var(--base-3);}:root .has-accent-color{color:var(--accent);}:root .has-accent-background-color{background-color:var(--accent);}body, button, input, select, textarea{font-family:-apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";}body{line-height:1.5;}.entry-content > [class*="wp-block-"]:not(:last-child):not(.wp-block-heading){margin-bottom:1.5em;}.main-navigation .main-nav ul ul li a{font-size:14px;}.sidebar .widget, .footer-widgets .widget{font-size:17px;}h1{font-weight:300;font-size:40px;}h2{font-weight:300;font-size:30px;}h3{font-size:20px;}h4{font-size:inherit;}h5{font-size:inherit;}@media (max-width:768px){.main-title{font-size:30px;}h1{font-size:30px;}h2{font-size:25px;}}.top-bar{background-color:#636363;color:#ffffff;}.top-bar a{color:#ffffff;}.top-bar a:hover{color:#303030;}.site-header{background-color:#ffffff;color:#3a3a3a;}.site-header a{color:#3a3a3a;}.main-title a,.main-title a:hover{color:#222222;}.site-description{color:#757575;}.main-navigation,.main-navigation ul ul{background-color:#222222;}.main-navigation .main-nav ul li a, .main-navigation .menu-toggle, .main-navigation .menu-bar-items{color:#ffffff;}.main-navigation .main-nav ul li:not([class*="current-menu-"]):hover > a, .main-navigation .main-nav ul li:not([class*="current-menu-"]):focus > a, .main-navigation .main-nav ul li.sfHover:not([class*="current-menu-"]) > a, .main-navigation .menu-bar-item:hover > a, .main-navigation .menu-bar-item.sfHover > a{color:#ffffff;background-color:#3f3f3f;}button.menu-toggle:hover,button.menu-toggle:focus,.main-navigation .mobile-bar-items a,.main-navigation .mobile-bar-items a:hover,.main-navigation .mobile-bar-items a:focus{color:#ffffff;}.main-navigation .main-nav ul li[class*="current-menu-"] > a{color:#ffffff;background-color:#3f3f3f;}.navigation-search input[type="search"],.navigation-search input[type="search"]:active, .navigation-search input[type="search"]:focus, .main-navigation .main-nav ul li.search-item.active > a, .main-navigation .menu-bar-items .search-item.active > a{color:#ffffff;background-color:#3f3f3f;}.main-navigation ul ul{background-color:#3f3f3f;}.main-navigation .main-nav ul ul li a{color:#ffffff;}.main-navigation .main-nav ul ul li:not([class*="current-menu-"]):hover > a,.main-navigation .main-nav ul ul li:not([class*="current-menu-"]):focus > a, .main-navigation .main-nav ul ul li.sfHover:not([class*="current-menu-"]) > a{color:#ffffff;background-color:#4f4f4f;}.main-navigation .main-nav ul ul li[class*="current-menu-"] > a{color:#ffffff;background-color:#4f4f4f;}.separate-containers .inside-article, .separate-containers .comments-area, .separate-containers .page-header, .one-container .container, .separate-containers .paging-navigation, .inside-page-header{background-color:#ffffff;}.entry-meta{color:#595959;}.entry-meta a{color:#595959;}.entry-meta a:hover{color:#1e73be;}.sidebar .widget{background-color:#ffffff;}.sidebar .widget .widget-title{color:#000000;}.footer-widgets{background-color:#ffffff;}.footer-widgets .widget-title{color:#000000;}.site-info{color:#ffffff;background-color:#222222;}.site-info a{color:#ffffff;}.site-info a:hover{color:#606060;}.footer-bar .widget_nav_menu .current-menu-item a{color:#606060;}input[type="text"],input[type="email"],input[type="url"],input[type="password"],input[type="search"],input[type="tel"],input[type="number"],textarea,select{color:#666666;background-color:#fafafa;border-color:#cccccc;}input[type="text"]:focus,input[type="email"]:focus,input[type="url"]:focus,input[type="password"]:focus,input[type="search"]:focus,input[type="tel"]:focus,input[type="number"]:focus,textarea:focus,select:focus{color:#666666;background-color:#ffffff;border-color:#bfbfbf;}button,html input[type="button"],input[type="reset"],input[type="submit"],a.button,a.wp-block-button__link:not(.has-background){color:#ffffff;background-color:#666666;}button:hover,html input[type="button"]:hover,input[type="reset"]:hover,input[type="submit"]:hover,a.button:hover,button:focus,html input[type="button"]:focus,input[type="reset"]:focus,input[type="submit"]:focus,a.button:focus,a.wp-block-button__link:not(.has-background):active,a.wp-block-button__link:not(.has-background):focus,a.wp-block-button__link:not(.has-background):hover{color:#ffffff;background-color:#3f3f3f;}a.generate-back-to-top{background-color:rgba( 0,0,0,0.4 );color:#ffffff;}a.generate-back-to-top:hover,a.generate-back-to-top:focus{background-color:rgba( 0,0,0,0.6 );color:#ffffff;}:root{--gp-search-modal-bg-color:var(--base-3);--gp-search-modal-text-color:var(--contrast);--gp-search-modal-overlay-bg-color:rgba(0,0,0,0.2);}@media (max-width:768px){.main-navigation .menu-bar-item:hover > a, .main-navigation .menu-bar-item.sfHover > a{background:none;color:#ffffff;}}.inside-top-bar{padding:10px;}.site-main .wp-block-group__inner-container{padding:40px;}.entry-content .alignwide, body:not(.no-sidebar) .entry-content .alignfull{margin-left:-40px;width:calc(100% + 80px);max-width:calc(100% + 80px);}.container.grid-container{max-width:1480px;}.rtl .menu-item-has-children .dropdown-menu-toggle{padding-left:20px;}.rtl .main-navigation .main-nav ul li.menu-item-has-children > a{padding-right:20px;}.site-info{padding:20px;}@media (max-width:768px){.separate-containers .inside-article, .separate-containers .comments-area, .separate-containers .page-header, .separate-containers .paging-navigation, .one-container .site-content, .inside-page-header{padding:30px;}.site-main .wp-block-group__inner-container{padding:30px;}.site-info{padding-right:10px;padding-left:10px;}.entry-content .alignwide, body:not(.no-sidebar) .entry-content .alignfull{margin-left:-30px;width:calc(100% + 60px);max-width:calc(100% + 60px);}}.one-container .sidebar .widget{padding:0px;}/* End cached CSS */@media (max-width:768px){.main-navigation .menu-toggle,.main-navigation .mobile-bar-items,.sidebar-nav-mobile:not(#sticky-placeholder){display:block;}.main-navigation ul,.gen-sidebar-nav{display:none;}[class*="nav-float-"] .site-header .inside-header > *{float:none;clear:both;}}</style>
<link rel="https://api.w.org/" href="/wp-json/">
<link rel="alternate" title="JSON" type="application/json" href="/wp-json/wp/v2/posts/6235">
<script defer src="https://cloud.umami.is/script.js" data-website-id="b31b5afd-a6bb-4cbc-ad87-f7d58d45fac2"></script>
    <link rel="icon" href="/wp-content/uploads/2019/12/cropped-makolyte-icon-512-e1575418903583-1-120x120.png" sizes="32x32">
<link rel="icon" href="/wp-content/uploads/2019/12/cropped-makolyte-icon-512-e1575418903583-1-300x300.png" sizes="192x192">
<link rel="apple-touch-icon" href="/wp-content/uploads/2019/12/cropped-makolyte-icon-512-e1575418903583-1-300x300.png">
<meta name="msapplication-TileImage" content="/wp-content/uploads/2019/12/cropped-makolyte-icon-512-e1575418903583-1-300x300.png">
		<style id="wp-custom-css">.site-header .header-image {
height: 128px;
width: 91px;
}

.yarpp-related a{
    font-weight:normal !important;
}

.home-column-title {
       word-wrap: normal;
       word-break: keep-all;
	     padding-right: 4em !important;
}

.posted-on .updated {
    display: inline-block;
}

.posted-on .updated + .entry-date {
    display: none;
}

.posted-on .updated:before {
    content: "Last updated on ";
}
.posted-on .published:before {
    content: "Last updated on ";
}

.mako-grid 
{
	display:grid;
	grid-template-columns: 1fr 1fr;
	gap: 34px;
}
@media screen and (max-width: 768px)
{
	.mako-grid{
		display:grid;
		grid-template-columns: 1fr;
		gap: 34px;
	}
}

.hljs {
  display: block;
  overflow-x: auto;
  padding: 0.5em;
  background: #1E1E1E;
  color: #DCDCDC;
}

.hljs-keyword,
.hljs-literal,
.hljs-symbol,
.hljs-name {
  color: #569CD6;
}
.hljs-link {
  color: #569CD6;
  text-decoration: underline;
}

.hljs-built_in,
.hljs-type {
  color: #4EC9B0;
}

.hljs-number,
.hljs-class {
  color: #B8D7A3;
}

.hljs-string,
.hljs-meta-string {
  color: #D69D85;
}

.hljs-regexp,
.hljs-template-tag {
  color: #9A5334;
}

.hljs-subst,
.hljs-function,
.hljs-title,
.hljs-params,
.hljs-formula {
  color: #DCDCDC;
}

.hljs-comment,
.hljs-quote {
  color: #57A64A;
  font-style: italic;
}

.hljs-doctag {
  color: #608B4E;
}

.hljs-meta,
.hljs-meta-keyword,
.hljs-tag {
  color: #9B9B9B;
}

.hljs-variable,
.hljs-template-variable {
  color: #BD63C5;
}

.hljs-attr,
.hljs-attribute,
.hljs-builtin-name {
  color: #9CDCFE;
}

.hljs-section {
  color: gold;
}

.hljs-emphasis {
  font-style: italic;
}

.hljs-strong {
  font-weight: bold;
}

.hljs-bullet,
.hljs-selector-tag,
.hljs-selector-id,
.hljs-selector-class,
.hljs-selector-attr,
.hljs-selector-pseudo {
  color: #D7BA7D;
}

.hljs-addition {
  background-color: #144212;
  display: inline-block;
  width: 100%;
}

.hljs-deletion {
  background-color: #600;
  display: inline-block;
  width: 100%;
}</style>
		</head>

<body class="post-template-default single single-post postid-6235 single-format-standard wp-custom-logo wp-embed-responsive right-sidebar nav-float-right one-container fluid-header active-footer-widgets-3 nav-search-enabled header-aligned-left dropdown-hover" itemtype="https://schema.org/Blog" itemscope>
	<a class="screen-reader-text skip-link" href="#content" title="Skip to content">Skip to content</a>		<header class="site-header" id="masthead" aria-label="Site" itemtype="https://schema.org/WPHeader" itemscope>
			<div class="inside-header grid-container grid-parent">
				<div class="site-branding-container">
<div class="site-logo">
					<a href="/" rel="home">
						<img class="header-image is-logo-image" alt="makolyte" src="/wp-content/uploads/2019/12/makolyte-icon-128-e1575419011285.png">
					</a>
				</div>
<div class="site-branding">
						<p class="main-title" itemprop="headline">
					<a href="/" rel="home">
						makolyte
					</a>
				</p>
						<p class="site-description" itemprop="description">
					Solve real coding problems
				</p>
					</div>
</div>		<nav class="main-navigation grid-container grid-parent sub-menu-right" id="site-navigation" aria-label="Primary" itemtype="https://schema.org/SiteNavigationElement" itemscope>
			<div class="inside-navigation grid-container grid-parent">
						<button class="menu-toggle" aria-controls="primary-menu" aria-expanded="false">
					<span class="gp-icon icon-menu-bars"><svg viewbox="0 0 512 512" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"><path d="M0 96c0-13.255 10.745-24 24-24h464c13.255 0 24 10.745 24 24s-10.745 24-24 24H24c-13.255 0-24-10.745-24-24zm0 160c0-13.255 10.745-24 24-24h464c13.255 0 24 10.745 24 24s-10.745 24-24 24H24c-13.255 0-24-10.745-24-24zm0 160c0-13.255 10.745-24 24-24h464c13.255 0 24 10.745 24 24s-10.745 24-24 24H24c-13.255 0-24-10.745-24-24z"></path></svg><svg viewbox="0 0 512 512" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"><path d="M71.029 71.029c9.373-9.372 24.569-9.372 33.942 0L256 222.059l151.029-151.03c9.373-9.372 24.569-9.372 33.942 0 9.372 9.373 9.372 24.569 0 33.942L289.941 256l151.03 151.029c9.372 9.373 9.372 24.569 0 33.942-9.373 9.372-24.569 9.372-33.942 0L256 289.941l-151.029 151.03c-9.373 9.372-24.569 9.372-33.942 0-9.372-9.373-9.372-24.569 0-33.942L222.059 256 71.029 104.971c-9.372-9.373-9.372-24.569 0-33.942z"></path></svg></span><span class="mobile-menu">Menu</span>				</button>
				<div id="primary-menu" class="main-nav"><ul id="menu-primary-menu" class=" menu sf-menu">
<li id="menu-item-15" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-15"><a href="/about/">About</a></li>
<li id="menu-item-305" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-305"><a href="/category/csharp/">C#</a></li>
<li id="menu-item-185" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-185"><a href="/category/sql/">SQL</a></li>

</ul></div>			</div>
		</nav>
					</div>
		</header>
		
	<div class="site grid-container container hfeed grid-parent" id="page">
				<div class="site-content" id="content">
			
	<div class="content-area grid-parent mobile-grid-100 grid-75 tablet-grid-75" id="primary">
		<main class="site-main" id="main">
			
<article id="post-6235" class="post-6235 post type-post status-publish format-standard hentry category-csharp tag-addhostedservice tag-addsingleton tag-appsettings-json tag-aspnetcore tag-await tag-backgroundservice tag-const tag-consumer-producer tag-datatable tag-datetime-now tag-dbnull tag-for-loop tag-hashset tag-httpclient tag-httpclient-getasync tag-interface tag-logging tag-manualreseteventslim tag-nameof tag-readonly tag-sqlbulkcopy tag-task-delay tag-taskcanceledexception tag-threading-channel tag-try-catch tag-typeof tag-while-loop" itemtype="https://schema.org/CreativeWork" itemscope>
	<div class="inside-article">
					<header class="entry-header" aria-label="Content">
				<h1 class="entry-title" itemprop="headline">Logging to the database with ASP.NET Core</h1>		<div class="entry-meta">
			<span class="posted-on"><time class="updated" datetime="2024-06-11T07:58:15-04:00" itemprop="dateModified">06/11/2024</time><time class="entry-date published" datetime="2021-08-14T09:24:59-04:00" itemprop="datePublished">08/14/2021</time></span> <span class="byline">by <span class="author vcard" itemprop="author" itemtype="https://schema.org/Person" itemscope><a class="url fn n" href="/about/" title="Get to know more about Mak" rel="author" itemprop="url"><span class="author-name" itemprop="name">Mak</span></a></span></span> 		</div>
					</header>
			
		<div class="entry-content" itemprop="text">
			
<p>I was reading about logging in ASP.NET when I came across this statement about logging to the database:</p>



<blockquote class="wp-block-quote is-layout-flow wp-block-quote-is-layout-flow">
<p>When logging to SQL Server, don&#8217;t do so directly. Instead, add log messages to an in-memory queue and have a background worker dequeue and insert data to SQL Server.</p>
<cite>Paraphrased from <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/logging/?view=aspnetcore-5.0#no-asynchronous-logger-methods-1" data-type="URL" data-id="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/logging/?view=aspnetcore-5.0#no-asynchronous-logger-methods-1">Microsoft &#8211; No asynchronous logger methods</a></cite>
</blockquote>



<p>In this article, I&#8217;ll show how to implement this background database logger idea. First, I&#8217;ll start by showing the design, and then I&#8217;ll show the code.</p>



<div id="ez-toc-container" class="ez-toc-v2_0_17_1 counter-hierarchy counter-decimal ez-toc-grey">
<div class="ez-toc-title-container">
<p class="ez-toc-title">Table of Contents</p>
<span class="ez-toc-title-toggle"></span>
</div>
<nav><ul class="ez-toc-list ez-toc-list-level-1">
<li class="ez-toc-page-1 ez-toc-heading-level-2"><a class="ez-toc-link ez-toc-heading-1" href="#Design" title="Design">Design</a></li>
<li class="ez-toc-page-1 ez-toc-heading-level-2">
<a class="ez-toc-link ez-toc-heading-2" href="#Code" title="Code">Code</a><ul class="ez-toc-list-level-3">
<li class="ez-toc-heading-level-3"><a class="ez-toc-link ez-toc-heading-3" href="#ILoggerService_and_a_controller_that_uses_it" title="ILoggerService and a controller that uses it">ILoggerService and a controller that uses it</a></li>
<li class="ez-toc-page-1 ez-toc-heading-level-3"><a class="ez-toc-link ez-toc-heading-4" href="#Log_repository_for_bulk_inserting" title="Log repository for bulk inserting">Log repository for bulk inserting</a></li>
<li class="ez-toc-page-1 ez-toc-heading-level-3"><a class="ez-toc-link ez-toc-heading-5" href="#Background_service_with_a_log_queue" title="Background service with a log queue">Background service with a log queue</a></li>
<li class="ez-toc-page-1 ez-toc-heading-level-3"><a class="ez-toc-link ez-toc-heading-6" href="#Registering_the_services" title="Registering the services">Registering the services</a></li>
<li class="ez-toc-page-1 ez-toc-heading-level-3"><a class="ez-toc-link ez-toc-heading-7" href="#Default_connection_string_in_appsettingsjson" title="Default connection string in appsettings.json">Default connection string in appsettings.json</a></li>
</ul>
</li>
<li class="ez-toc-page-1 ez-toc-heading-level-2"><a class="ez-toc-link ez-toc-heading-8" href="#Run_it" title="Run it">Run it</a></li>
<li class="ez-toc-page-1 ez-toc-heading-level-2"><a class="ez-toc-link ez-toc-heading-9" href="#Source_code" title="Source code">Source code</a></li>
</ul></nav>
</div>
<h2 class="wp-block-heading">
<span class="ez-toc-section" id="Design"></span>Design<span class="ez-toc-section-end"></span>
</h2>



<p>We can implement Microsoft&#8217;s background database logger idea by using the consumer/producer pattern with a background service. To make sure this scales well, we&#8217;ll bulk insert log messages into the database.</p>



<p>I&#8217;ll go into details about this design, but first here&#8217;s the design diagram:</p>



<figure class="wp-block-image size-large"><img fetchpriority="high" decoding="async" width="594" height="524" src="/wp-content/uploads/2021/08/background-database-logger.png" alt="Design diagram - ASP.NET Service with controllers and a background service, which contains a log queue. The controllers enqueue messages to the log queue, and the messages are dequeued in batches and bulk inserted into the database." class="wp-image-6383" srcset="/wp-content/uploads/2021/08/background-database-logger.png 594w, /wp-content/uploads/2021/08/background-database-logger-300x265.png 300w" sizes="(max-width: 594px) 100vw, 594px"></figure>



<p>With the consumer/producer pattern, you have one or more producers enqueuing messages to a shared queue. You have one or more consumers dequeuing messages from the shared queue and processing them. In our case, we&#8217;ll have multiple producers (anything that logs, mostly controllers), and a single consumer.</p>



<p>In ASP.NET, you can <a href="/aspdotnet-how-to-use-a-backgroundservice-for-long-running-and-periodic-tasks/" data-type="post" data-id="2278">add hosted services that run in the background</a>. These are referred to as background services. We&#8217;ll use a background service for two purposes: it&#8217;ll contain the shared queue, and it&#8217;ll act as the consumer.</p>



<p>The producers only need to be exposed to a Log() method. They don&#8217;t need to know they&#8217;re using a background service, or that it&#8217;s logging to the database. This is why we&#8217;re using the ILoggerService interface.</p>



<p>Since there can be multiple producers, there can be multiple log messages coming in at the same time. Executing lots of individual INSERT statements can degrade system performance. Instead, we&#8217;ll <a href="/csharp-how-to-use-sqlbulkcopy-to-do-a-bulk-insert/" data-type="post" data-id="3901">bulk insert the messages to the database</a>. In order to bulk insert, the consumer will need to be able to batch read from the queue.</p>



<h2 class="wp-block-heading">
<span class="ez-toc-section" id="Code"></span>Code<span class="ez-toc-section-end"></span>
</h2>



<p>In this section, I&#8217;ll show the code for the design shown above. I&#8217;ll be building this from the outside-in, and building the background service last.</p>



<p>Throughout this code, I&#8217;ll be using Console.WriteLine(). I&#8217;m running the service with a console interface so I can easily see what&#8217;s going on.</p>



<h3 class="wp-block-heading">
<span class="ez-toc-section" id="ILoggerService_and_a_controller_that_uses_it"></span>ILoggerService and a controller that uses it<span class="ez-toc-section-end"></span>
</h3>



<p>First things first, we need to add ILoggerService. It&#8217;s best practice to code against interfaces instead of implementations. The producers only need to have access to the Log() method. They don&#8217;t need to know anything about the concrete implementation.</p>


<pre class="wp-block-code" aria-describedby="shcb-language-1" data-shcb-language-name="C#" data-shcb-language-slug="cs"><span><code class="hljs language-cs shcb-code-table shcb-line-numbers"><span class="shcb-loc"><span><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">ILoggerService</span>
</span></span><span class="shcb-loc"><span>{
</span></span><span class="shcb-loc"><span>	<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Log</span>(<span class="hljs-params">LogLevel logLevel, <span class="hljs-keyword">string</span> message</span>)</span>;
</span></span><span class="shcb-loc"><span>}
</span></span></code></span><small class="shcb-language" id="shcb-language-1"><span class="shcb-language__label">Code language:</span> <span class="shcb-language__name">C#</span> <span class="shcb-language__paren">(</span><span class="shcb-language__slug">cs</span><span class="shcb-language__paren">)</span></small></pre>


<p><em>Note: I&#8217;m not using the built-in ILogger. It has a huge amount of methods, and I didn&#8217;t want to have to implement them in the background service.</em></p>



<p>Here&#8217;s an example of a controller that logs messages. It needs ILoggerService dependency injected.</p>


<pre class="wp-block-code" aria-describedby="shcb-language-2" data-shcb-language-name="C#" data-shcb-language-slug="cs"><span><code class="hljs language-cs shcb-code-table shcb-line-numbers"><span class="shcb-loc"><span>&#91;<span class="hljs-meta">Route(<span class="hljs-meta-string">"&#91;controller]"</span>)</span>]
</span></span><span class="shcb-loc"><span>&#91;<span class="hljs-meta">ApiController</span>]
</span></span><span class="shcb-loc"><span><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">RecipesController</span> : <span class="hljs-title">ControllerBase</span>
</span></span><span class="shcb-loc"><span>{
</span></span><span class="shcb-loc"><span>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ILoggerService Logger;
</span></span><span class="shcb-loc"><span>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">RecipesController</span>(<span class="hljs-params">ILoggerService logger</span>)</span>
</span></span><span class="shcb-loc"><span>	{
</span></span><span class="shcb-loc"><span>		Logger = logger;
</span></span><span class="shcb-loc"><span>	}
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span>	&#91;<span class="hljs-meta">HttpGet(<span class="hljs-meta-string">"{id}"</span>)</span>]
</span></span><span class="shcb-loc"><span>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> <span class="hljs-title">Get</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> id</span>)</span>
</span></span><span class="shcb-loc"><span>	{
</span></span><span class="shcb-loc"><span>		Logger.Log(LogLevel.Debug, <span class="hljs-string">$"GET /Recipes/<span class="hljs-subst">{id}</span>"</span>);
</span></span><span class="shcb-loc"><span>		<span class="hljs-keyword">return</span> <span class="hljs-string">"recipe"</span>;
</span></span><span class="shcb-loc"><span>	}
</span></span><span class="shcb-loc"><span>}
</span></span></code></span><small class="shcb-language" id="shcb-language-2"><span class="shcb-language__label">Code language:</span> <span class="shcb-language__name">C#</span> <span class="shcb-language__paren">(</span><span class="shcb-language__slug">cs</span><span class="shcb-language__paren">)</span></small></pre>


<h3 class="wp-block-heading">
<span class="ez-toc-section" id="Log_repository_for_bulk_inserting"></span>Log repository for bulk inserting<span class="ez-toc-section-end"></span>
</h3>



<p>We want to bulk insert the log messages. Any time you&#8217;re interacting with a database, it&#8217;s a good idea to implement the repository pattern. With this pattern, you encapsulate the database interaction logic in a repository class. </p>



<p>First, we need to add the LogMessage model class:</p>


<pre class="wp-block-code" aria-describedby="shcb-language-3" data-shcb-language-name="C#" data-shcb-language-slug="cs"><span><code class="hljs language-cs shcb-code-table shcb-line-numbers"><span class="shcb-loc"><span><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">LogMessage</span>
</span></span><span class="shcb-loc"><span>{
</span></span><span class="shcb-loc"><span>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> ThreadId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
</span></span><span class="shcb-loc"><span>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Message { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
</span></span><span class="shcb-loc"><span>	<span class="hljs-keyword">public</span> DateTimeOffset Timestamp { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
</span></span><span class="shcb-loc"><span>}
</span></span></code></span><small class="shcb-language" id="shcb-language-3"><span class="shcb-language__label">Code language:</span> <span class="shcb-language__name">C#</span> <span class="shcb-language__paren">(</span><span class="shcb-language__slug">cs</span><span class="shcb-language__paren">)</span></small></pre>


<p>Next, since we want to use SqlBulkCopy, and we&#8217;re using the latest .NET (not .NET Framework), we&#8217;ll need to install the System.Data.SqlClient package. Do that by executing the following command (<em>Note: this is using View > Other Windows > Package Manager Console)</em>:</p>


<pre class="wp-block-code" aria-describedby="shcb-language-4" data-shcb-language-name="PowerShell" data-shcb-language-slug="powershell"><span><code class="hljs language-powershell shcb-code-table shcb-line-numbers"><span class="shcb-loc"><span><span class="hljs-built_in">Install-Package</span> System.Data.SqlClient
</span></span></code></span><small class="shcb-language" id="shcb-language-4"><span class="shcb-language__label">Code language:</span> <span class="shcb-language__name">PowerShell</span> <span class="shcb-language__paren">(</span><span class="shcb-language__slug">powershell</span><span class="shcb-language__paren">)</span></small></pre>


<p>Now we can implement the LogRepository class. It will do a bulk insertion using SqlBulkCopy.</p>



<p>Whenever you&#8217;re interacting with an external dependency, such as a database, it&#8217;s a good idea to make it fault tolerant and <a href="/csharp-how-to-use-polly-to-do-retries/" data-type="post" data-id="6815">retry when transient errors happen</a>. In this case, we&#8217;ll try to make this resilient by catching a few transient SQL exceptions and retrying the bulk insertion a few times.</p>



<p>Here&#8217;s the LogRepository class:</p>


<pre class="wp-block-code" aria-describedby="shcb-language-5" data-shcb-language-name="C#" data-shcb-language-slug="cs"><span><code class="hljs language-cs shcb-code-table shcb-line-numbers"><span class="shcb-loc"><span><span class="hljs-keyword">using</span> System.Data;
</span></span><span class="shcb-loc"><span><span class="hljs-keyword">using</span> System.Data.SqlClient;
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">LogRepository</span> : <span class="hljs-title">ILogRepository</span>
</span></span><span class="shcb-loc"><span>{
</span></span><span class="shcb-loc"><span>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">string</span> TABLE = <span class="hljs-string">"Log"</span>;
</span></span><span class="shcb-loc"><span>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">string</span> ConnectionString;
</span></span><span class="shcb-loc"><span>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> HashSet&lt;<span class="hljs-keyword">int</span>&gt; transientSqlErrors = <span class="hljs-keyword">new</span> HashSet&lt;<span class="hljs-keyword">int</span>&gt;()
</span></span><span class="shcb-loc"><span>	{
</span></span><span class="shcb-loc"><span>		<span class="hljs-number">-2</span>, <span class="hljs-number">258</span>, <span class="hljs-number">4060</span>
</span></span><span class="shcb-loc"><span>	};
</span></span><span class="shcb-loc"><span>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> MAX_RETRIES = <span class="hljs-number">3</span>;
</span></span><span class="shcb-loc"><span>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> RETRY_SECONDS = <span class="hljs-number">5</span>;
</span></span><span class="shcb-loc"><span>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">LogRepository</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> connectionString</span>)</span>
</span></span><span class="shcb-loc"><span>	{
</span></span><span class="shcb-loc"><span>		ConnectionString = connectionString;
</span></span><span class="shcb-loc"><span>	}
</span></span><span class="shcb-loc"><span>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">Insert</span>(<span class="hljs-params">List&lt;LogMessage&gt; logMessages</span>)</span>
</span></span><span class="shcb-loc"><span>	{
</span></span><span class="shcb-loc"><span>		DataTable table = <span class="hljs-keyword">new</span> DataTable();
</span></span><span class="shcb-loc"><span>		table.TableName = TABLE;
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span>		table.Columns.Add(<span class="hljs-keyword">nameof</span>(LogMessage.Timestamp), <span class="hljs-keyword">typeof</span>(DateTimeOffset));
</span></span><span class="shcb-loc"><span>		table.Columns.Add(<span class="hljs-keyword">nameof</span>(LogMessage.Message), <span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">string</span>));
</span></span><span class="shcb-loc"><span>		table.Columns.Add(<span class="hljs-keyword">nameof</span>(LogMessage.ThreadId), <span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">int</span>));
</span></span><span class="shcb-loc"><span>		<span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> logMessage <span class="hljs-keyword">in</span> logMessages)
</span></span><span class="shcb-loc"><span>		{
</span></span><span class="shcb-loc"><span>			<span class="hljs-keyword">var</span> row = table.NewRow();
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span>			row&#91;<span class="hljs-keyword">nameof</span>(LogMessage.Timestamp)] = logMessage.Timestamp;
</span></span><span class="shcb-loc"><span>			row&#91;<span class="hljs-keyword">nameof</span>(LogMessage.Message)] = logMessage.Message ?? (<span class="hljs-keyword">object</span>)DBNull.Value;
</span></span><span class="shcb-loc"><span>			row&#91;<span class="hljs-keyword">nameof</span>(LogMessage.ThreadId)] = logMessage.ThreadId;
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span>			table.Rows.Add(row);
</span></span><span class="shcb-loc"><span>		}
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span>		<span class="hljs-keyword">await</span> BulkInsertWithRetries(table);
</span></span><span class="shcb-loc"><span>	}
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">BulkInsertWithRetries</span>(<span class="hljs-params">DataTable table</span>)</span>
</span></span><span class="shcb-loc"><span>	{
</span></span><span class="shcb-loc"><span>		<span class="hljs-keyword">int</span> attempts = <span class="hljs-number">1</span>;
</span></span><span class="shcb-loc"><span>		<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)
</span></span><span class="shcb-loc"><span>		{
</span></span><span class="shcb-loc"><span>			<span class="hljs-keyword">try</span>
</span></span><span class="shcb-loc"><span>			{
</span></span><span class="shcb-loc"><span>				<span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> sqlBulkCopy = <span class="hljs-keyword">new</span> SqlBulkCopy(ConnectionString))
</span></span><span class="shcb-loc"><span>				{
</span></span><span class="shcb-loc"><span>					sqlBulkCopy.DestinationTableName = table.TableName;
</span></span><span class="shcb-loc"><span>					<span class="hljs-keyword">await</span> sqlBulkCopy.WriteToServerAsync(table);
</span></span><span class="shcb-loc"><span>					<span class="hljs-keyword">return</span>;
</span></span><span class="shcb-loc"><span>				}
</span></span><span class="shcb-loc"><span>			}
</span></span><span class="shcb-loc"><span>			<span class="hljs-keyword">catch</span> (SqlException sqlEx)
</span></span><span class="shcb-loc"><span>			<span class="hljs-keyword">when</span> (transientSqlErrors.Contains(sqlEx.Number) &amp;&amp; attempts &lt;= MAX_RETRIES)
</span></span><span class="shcb-loc"><span>			{
</span></span><span class="shcb-loc"><span>				Console.WriteLine(<span class="hljs-string">$"Transient SQL error. Retrying in <span class="hljs-subst">{RETRY_SECONDS}</span> seconds"</span>);
</span></span><span class="shcb-loc"><span>				<span class="hljs-keyword">await</span> Task.Delay(TimeSpan.FromSeconds(RETRY_SECONDS));
</span></span><span class="shcb-loc"><span>				attempts++;
</span></span><span class="shcb-loc"><span>			}
</span></span><span class="shcb-loc"><span>		}
</span></span><span class="shcb-loc"><span>	}
</span></span><span class="shcb-loc"><span>}
</span></span></code></span><small class="shcb-language" id="shcb-language-5"><span class="shcb-language__label">Code language:</span> <span class="shcb-language__name">C#</span> <span class="shcb-language__paren">(</span><span class="shcb-language__slug">cs</span><span class="shcb-language__paren">)</span></small></pre>


<p><em>Note: We could<a href="/csharp-how-to-use-table-valued-parameters-tvp-with-ado-net-dapper-and-ef-core/" data-type="post" data-id="6429"> use a table-valued parameter (TVP) approach</a> in this scenario instead of doing a bulk insert. The main goal here is to do a set-based approach so we&#8217;re not spamming the system with lots of individual inserts. Both approaches (TVP and bulk insert) work fine for this.</em></p>



<h3 class="wp-block-heading">
<span class="ez-toc-section" id="Background_service_with_a_log_queue"></span>Background service with a log queue<span class="ez-toc-section-end"></span>
</h3>



<p>Finally we can add the background service class and call it DatabaseLoggerService. To make this run as a background service, we have to implement BackgroundService.</p>



<p>We&#8217;ll implement the consumer/producer pattern by adding <a href="/event-driven-dotnet-concurrent-producer-consumer-using-a-channel-as-a-non-blocking-async-queue/" data-type="post" data-id="2193">an async queue from System.Threading.Channels</a>. The ILoggerService.Log() method will allow producers to enqueue log messages. We&#8217;ll implement the consumer loop in ExecuteAsync() (a method from BackgroundService).</p>



<p>Here&#8217;s the DatabaseLoggerService class:</p>


<pre class="wp-block-code" aria-describedby="shcb-language-6" data-shcb-language-name="C#" data-shcb-language-slug="cs"><span><code class="hljs language-cs shcb-code-table shcb-line-numbers shcb-wrap-lines"><span class="shcb-loc"><span><span class="hljs-keyword">using</span> Microsoft.Extensions.Hosting;
</span></span><span class="shcb-loc"><span><span class="hljs-keyword">using</span> Microsoft.Extensions.Logging;
</span></span><span class="shcb-loc"><span><span class="hljs-keyword">using</span> System.Threading.Channels;
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseLoggerService</span> : <span class="hljs-title">BackgroundService</span>, <span class="hljs-title">ILoggerService</span>
</span></span><span class="shcb-loc"><span>{
</span></span><span class="shcb-loc"><span>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> Channel&lt;LogMessage&gt; logMessageQueue;
</span></span><span class="shcb-loc"><span>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IHostApplicationLifetime HostApplicationLifetime;
</span></span><span class="shcb-loc"><span>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> MAX_BATCH_SIZE = <span class="hljs-number">10</span>;
</span></span><span class="shcb-loc"><span>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ILogRepository LogRepository;
</span></span><span class="shcb-loc"><span>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DatabaseLoggerService</span>(<span class="hljs-params">ILogRepository logRepository, IHostApplicationLifetime hostApplicationLifetime</span>)</span>
</span></span><span class="shcb-loc"><span>	{
</span></span><span class="shcb-loc"><span>		logMessageQueue = Channel.CreateUnbounded&lt;LogMessage&gt;();
</span></span><span class="shcb-loc"><span>		LogRepository = logRepository;
</span></span><span class="shcb-loc"><span>		HostApplicationLifetime = hostApplicationLifetime;
</span></span><span class="shcb-loc"><span>	}
</span></span><span class="shcb-loc"><span>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">override</span> Task <span class="hljs-title">StopAsync</span>(<span class="hljs-params">CancellationToken cancellationToken</span>)</span>
</span></span><span class="shcb-loc"><span>	{
</span></span><span class="shcb-loc"><span>		<span class="hljs-keyword">await</span> <span class="hljs-keyword">base</span>.StopAsync(cancellationToken);
</span></span><span class="shcb-loc"><span>	}
</span></span><span class="shcb-loc"><span>	<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">override</span> Task <span class="hljs-title">ExecuteAsync</span>(<span class="hljs-params">CancellationToken stoppingToken</span>)</span>
</span></span><span class="shcb-loc"><span>	{
</span></span><span class="shcb-loc"><span>		<span class="hljs-keyword">while</span>(!stoppingToken.IsCancellationRequested)
</span></span><span class="shcb-loc"><span>		{
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span>			<span class="hljs-keyword">try</span>
</span></span><span class="shcb-loc"><span>			{
</span></span><span class="shcb-loc"><span>				Console.WriteLine(<span class="hljs-string">"Waiting for log messages"</span>);
</span></span><span class="shcb-loc"><span>				<span class="hljs-keyword">var</span> batch = <span class="hljs-keyword">await</span> GetBatch(stoppingToken);
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span>				Console.WriteLine(<span class="hljs-string">$"Got a batch with <span class="hljs-subst">{batch.Count}</span>(s) log messages. Bulk inserting them now."</span>);
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span>				<span class="hljs-comment">//Let non-retryable errors from this bubble up and crash the service</span>
</span></span><span class="shcb-loc"><span>				<span class="hljs-keyword">await</span> LogRepository.Insert(batch);
</span></span><span class="shcb-loc"><span>			}
</span></span><span class="shcb-loc"><span>			<span class="hljs-keyword">catch</span> (TaskCanceledException)
</span></span><span class="shcb-loc"><span>			{
</span></span><span class="shcb-loc"><span>				Console.WriteLine(<span class="hljs-string">"Stopping token was canceled, which means the service is shutting down."</span>);
</span></span><span class="shcb-loc"><span>				<span class="hljs-keyword">return</span>;
</span></span><span class="shcb-loc"><span>			}
</span></span><span class="shcb-loc"><span>			<span class="hljs-keyword">catch</span> (Exception ex)
</span></span><span class="shcb-loc"><span>			{
</span></span><span class="shcb-loc"><span>				Console.WriteLine(<span class="hljs-string">$"Fatal exception in database logger. Crashing service. Error=<span class="hljs-subst">{ex}</span>"</span>);
</span></span><span class="shcb-loc"><span>				HostApplicationLifetime.StopApplication();
</span></span><span class="shcb-loc"><span>				<span class="hljs-keyword">return</span>;
</span></span><span class="shcb-loc"><span>			}
</span></span><span class="shcb-loc"><span>		}
</span></span><span class="shcb-loc"><span>	}
</span></span><span class="shcb-loc"><span>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Log</span>(<span class="hljs-params">LogLevel logLevel, <span class="hljs-keyword">string</span> message</span>)</span>
</span></span><span class="shcb-loc"><span>	{
</span></span><span class="shcb-loc"><span>		<span class="hljs-comment">//The reason to use Writer.TryWrite() is because it's synchronous.</span>
</span></span><span class="shcb-loc"><span>		<span class="hljs-comment">//We want the logging to be as fast as possible for the client, so</span>
</span></span><span class="shcb-loc"><span>		<span class="hljs-comment">//we don't want the overhead of async</span>
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span>		<span class="hljs-comment">//Note: We're using an unbounded Channel, so TryWrite() *should* only fail </span>
</span></span><span class="shcb-loc"><span>		<span class="hljs-comment">//if we call writer.Complete().</span>
</span></span><span class="shcb-loc"><span>		<span class="hljs-comment">//Guard against it anyway</span>
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span>		<span class="hljs-keyword">var</span> logMessage = <span class="hljs-keyword">new</span> LogMessage()
</span></span><span class="shcb-loc"><span>		{
</span></span><span class="shcb-loc"><span>			Message = message,
</span></span><span class="shcb-loc"><span>			ThreadId = System.Threading.Thread.CurrentThread.ManagedThreadId,
</span></span><span class="shcb-loc"><span>			Timestamp = DateTimeOffset.Now
</span></span><span class="shcb-loc"><span>		};
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span>		<span class="hljs-keyword">if</span> (!logMessageQueue.Writer.TryWrite(logMessage))
</span></span><span class="shcb-loc"><span>		{
</span></span><span class="shcb-loc"><span>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">"Failed to write the log message"</span>);
</span></span><span class="shcb-loc"><span>		}
</span></span><span class="shcb-loc"><span>	}
</span></span><span class="shcb-loc"><span>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task&lt;List&lt;LogMessage&gt;&gt; GetBatch(CancellationToken cancellationToken)
</span></span><span class="shcb-loc"><span>	{
</span></span><span class="shcb-loc"><span>		<span class="hljs-keyword">await</span> logMessageQueue.Reader.WaitToReadAsync(cancellationToken);
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span>		<span class="hljs-keyword">var</span> batch = <span class="hljs-keyword">new</span> List&lt;LogMessage&gt;();
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span>		<span class="hljs-keyword">while</span> (batch.Count &lt; MAX_BATCH_SIZE &amp;&amp; logMessageQueue.Reader.TryRead(<span class="hljs-keyword">out</span> LogMessage message))
</span></span><span class="shcb-loc"><span>		{
</span></span><span class="shcb-loc"><span>			batch.Add(message);
</span></span><span class="shcb-loc"><span>		}
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span>		<span class="hljs-keyword">return</span> batch;
</span></span><span class="shcb-loc"><span>	}
</span></span><span class="shcb-loc"><span>}
</span></span></code></span><small class="shcb-language" id="shcb-language-6"><span class="shcb-language__label">Code language:</span> <span class="shcb-language__name">C#</span> <span class="shcb-language__paren">(</span><span class="shcb-language__slug">cs</span><span class="shcb-language__paren">)</span></small></pre>


<p>The producers will call Log() synchronously. This is fast because all it&#8217;s doing is enqueuing the message. </p>



<p>The consumer loop <a href="/csharp-how-to-batch-read-with-threading-channelreader/" data-type="post" data-id="6240">reads a batch of messages from the queue</a> and then awaits the bulk insertion. I wouldn&#8217;t suggest fire and forgetting the bulk insertion. For one, waiting for it to complete acts as a throttling mechanism. You&#8217;re only ever doing one bulk insertion at once. Second, it simplifies error handling.</p>



<p>Notice that this is is calling StopApplication() if an exception bubbles up from LogRepository. As noted in the LogRepository section, it&#8217;s retrying a few times if there are transient SQL exceptions. For any other type of error, or if it exceeds the max retries, it&#8217;ll throw. This will trigger a <a href="/aspnetcore-control-the-graceful-shutdown-time-for-background-services/" data-type="post" data-id="17238">graceful shutdown</a> of the entire service, not just crash the background service. There are definitely other possible ways to handle this (such as logging to a fallback file). I decided to do the simplest approach with the assumption that this logging is critical and the service should stop if it fails to log.</p>



<h3 class="wp-block-heading">
<span class="ez-toc-section" id="Registering_the_services"></span>Registering the services<span class="ez-toc-section-end"></span>
</h3>



<p>To register DatabaseLoggerService, use both of these:</p>



<ul class="wp-block-list">
<li>AddSingleton() &#8211;  So it can be <a href="/aspdotnet-dependency-inject-a-background-service-into-the-controllers/" data-type="post" data-id="6267">dependency injected into the controllers</a>.</li>



<li>AddHostedService() &#8211; Because it&#8217;s a hosted background service.</li>
</ul>



<p>Here&#8217;s an example:</p>


<pre class="wp-block-code" aria-describedby="shcb-language-7" data-shcb-language-name="C#" data-shcb-language-slug="cs"><span><code class="hljs language-cs shcb-code-table shcb-line-numbers"><span class="shcb-loc"><span><span class="hljs-comment">//rest of adding services</span>
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span>builder.Services.AddSingleton&lt;ILogRepository, LogRepository&gt;(_ 
</span></span><span class="shcb-loc"><span>			=&gt; <span class="hljs-keyword">new</span> LogRepository(Configuration.GetConnectionString(<span class="hljs-string">"Default"</span>)));
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span>builder.Services.AddSingleton&lt;ILoggerService, DatabaseLoggerService&gt;();
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span>builder.Services.AddHostedService(sp =&gt; sp.GetService&lt;ILoggerService&gt;() <span class="hljs-keyword">as</span> DatabaseLoggerService);
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span><span class="hljs-comment">//Rest of init code</span>
</span></span></code></span><small class="shcb-language" id="shcb-language-7"><span class="shcb-language__label">Code language:</span> <span class="shcb-language__name">C#</span> <span class="shcb-language__paren">(</span><span class="shcb-language__slug">cs</span><span class="shcb-language__paren">)</span></small></pre>


<p><em>Note: Before .NET 6, do this in Startup.ConfigureServices().</em></p>



<h3 class="wp-block-heading">
<span class="ez-toc-section" id="Default_connection_string_in_appsettingsjson"></span>Default connection string in appsettings.json<span class="ez-toc-section-end"></span>
</h3>



<p>We can add a placeholder for the connection string in appsettings.json, and then add the real connection string as a <a href="/how-to-add-user-secrets-in-a-dotnetcore-console-app/" data-type="post" data-id="3228">user secret</a>. </p>


<pre class="wp-block-code" aria-describedby="shcb-language-8" data-shcb-language-name="JSON / JSON with Comments" data-shcb-language-slug="json"><span><code class="hljs language-json shcb-code-table shcb-line-numbers"><span class="shcb-loc"><span>{
</span></span><span class="shcb-loc"><span>  <span class="hljs-attr">"Logging"</span>: {
</span></span><span class="shcb-loc"><span>    <span class="hljs-attr">"LogLevel"</span>: {
</span></span><span class="shcb-loc"><span>      <span class="hljs-attr">"Default"</span>: <span class="hljs-string">"Information"</span>,
</span></span><span class="shcb-loc"><span>      <span class="hljs-attr">"Microsoft"</span>: <span class="hljs-string">"Warning"</span>,
</span></span><span class="shcb-loc"><span>      <span class="hljs-attr">"Microsoft.Hosting.Lifetime"</span>: <span class="hljs-string">"Information"</span>
</span></span><span class="shcb-loc"><span>    }
</span></span><span class="shcb-loc"><span>  },
</span></span><span class="shcb-loc"><span>  <span class="hljs-attr">"AllowedHosts"</span>: <span class="hljs-string">"*"</span>,
</span></span><span class="shcb-loc"><span>  <span class="hljs-attr">"ConnectionStrings"</span>: {
</span></span><mark class="shcb-loc"><span>    <span class="hljs-attr">"Default"</span>: <span class="hljs-string">"The connection string is defined in the user secrets file"</span>
</span></mark><span class="shcb-loc"><span>  }
</span></span><span class="shcb-loc"><span>}
</span></span><span class="shcb-loc"><span>
</span></span></code></span><small class="shcb-language" id="shcb-language-8"><span class="shcb-language__label">Code language:</span> <span class="shcb-language__name">JSON / JSON with Comments</span> <span class="shcb-language__paren">(</span><span class="shcb-language__slug">json</span><span class="shcb-language__paren">)</span></small></pre>


<h2 class="wp-block-heading">
<span class="ez-toc-section" id="Run_it"></span>Run it<span class="ez-toc-section-end"></span>
</h2>



<p>To test this out and see it in action, run the ASP.NET service and <a href="/csharp-how-to-make-concurrent-requests-with-httpclient/" data-type="post" data-id="2028">send concurrent requests with HttpClient</a>. Check the Log table in the database to verify that it inserted the messages.</p>



<p>To see the bulk insertions work, use the following test client that sends tons of concurrent requests:</p>


<pre class="wp-block-code" aria-describedby="shcb-language-9" data-shcb-language-name="C#" data-shcb-language-slug="cs"><span><code class="hljs language-cs shcb-code-table shcb-line-numbers"><span class="shcb-loc"><span><span class="hljs-keyword">var</span> httpClient = <span class="hljs-keyword">new</span> HttpClient();
</span></span><span class="shcb-loc"><span><span class="hljs-keyword">var</span> go = <span class="hljs-keyword">new</span> ManualResetEventSlim();
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">77</span>; i++)
</span></span><span class="shcb-loc"><span>{
</span></span><span class="shcb-loc"><span>	<span class="hljs-keyword">var</span> num = i; <span class="hljs-comment">//capture for closure</span>
</span></span><span class="shcb-loc"><span>	Task.Run(<span class="hljs-keyword">async</span> () =&gt;
</span></span><span class="shcb-loc"><span>	{
</span></span><span class="shcb-loc"><span>		Console.WriteLine(<span class="hljs-string">$"Num <span class="hljs-subst">{num}</span> waiting"</span>);
</span></span><span class="shcb-loc"><span>		go.Wait();
</span></span><span class="shcb-loc"><span>		Console.WriteLine(<span class="hljs-string">$"Num <span class="hljs-subst">{num}</span> going"</span>);
</span></span><span class="shcb-loc"><span>		<span class="hljs-keyword">var</span> response = <span class="hljs-keyword">await</span> httpClient.GetAsync(<span class="hljs-string">$"https://localhost:12345/Recipes/<span class="hljs-subst">{num}</span>"</span>);
</span></span><span class="shcb-loc"><span>		response.EnsureSuccessStatusCode();
</span></span><span class="shcb-loc"><span>		
</span></span><span class="shcb-loc"><span>		Console.WriteLine(<span class="hljs-string">$"Num <span class="hljs-subst">{num}</span> done"</span>);
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span>	});
</span></span><span class="shcb-loc"><span>}
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span>go.Set();
</span></span><span class="shcb-loc"><span>
</span></span><span class="shcb-loc"><span>Console.ReadLine();
</span></span></code></span><small class="shcb-language" id="shcb-language-9"><span class="shcb-language__label">Code language:</span> <span class="shcb-language__name">C#</span> <span class="shcb-language__paren">(</span><span class="shcb-language__slug">cs</span><span class="shcb-language__paren">)</span></small></pre>


<p><em>Note: I tried sending concurrent <a href="/how-to-send-a-request-with-postman/" data-type="post" data-id="12735">requests with Postman</a>, but it was too slow.</em></p>



<p>In addition to seeing the bulk insertions working, you can induce a transient SQL exception to see it do retries. The simplest way to do that is to set the database offline manually, wait for it to report the transient error, and then set the database back online manually.</p>



<p>Here&#8217;s an example of what it looks like when you run this:</p>


<pre class="wp-block-code" aria-describedby="shcb-language-10" data-shcb-language-name="plaintext" data-shcb-language-slug="plaintext"><span><code class="hljs language-plaintext">CommandLoop starting
Waiting for log messages
Got a batch with 7(s) log messages. Bulk inserting them now.
Transient SQL error. Retrying in 5 seconds
Waiting for log messages
Got a batch with 10(s) log messages. Bulk inserting them now.
Waiting for log messages
Got a batch with 10(s) log messages. Bulk inserting them now.
Waiting for log messages
Got a batch with 10(s) log messages. Bulk inserting them now.
Waiting for log messages
Got a batch with 10(s) log messages. Bulk inserting them now.
Waiting for log messages
Got a batch with 10(s) log messages. Bulk inserting them now.
Waiting for log messages
Got a batch with 10(s) log messages. Bulk inserting them now.
Waiting for log messages
Got a batch with 10(s) log messages. Bulk inserting them now.
Waiting for log messages</code></span><small class="shcb-language" id="shcb-language-10"><span class="shcb-language__label">Code language:</span> <span class="shcb-language__name">plaintext</span> <span class="shcb-language__paren">(</span><span class="shcb-language__slug">plaintext</span><span class="shcb-language__paren">)</span></small></pre>


<p>The consumer reads between 1-10 messages from the queue. If there are 10 messages available, it&#8217;ll read all 10. Otherwise, it will read as many as it can. In the first instance, notice that it only read 7 messages. That&#8217;s because there were only 7 messages available on the queue at the time. After that, it was able to read 10 messages every time.</p>



<p>Also notice that it detected the transient SQL error, waited 5 seconds, and tried again. It succeeded when it retried.</p>



<h2 class="wp-block-heading">
<span class="ez-toc-section" id="Source_code"></span>Source code<span class="ez-toc-section-end"></span>
</h2>



<p>The full source code for the background database logger shown in this article is available here: <a rel="noreferrer noopener" href="https://github.com/makolyte/aspdotnet-background-dblogger" target="_blank">https://github.com/makolyte/aspdotnet-background-dblogger</a></p>
<div class="related_content" style="clear:both;">
<h3 class="widget-title">Related Articles</h3>
									<ul class="related-posts">
										<li class="related-post">
											<a href="/aspdotnet-how-to-use-a-backgroundservice-for-long-running-and-periodic-tasks/">How to use BackgroundService in ASP.NET Core</a>
										</li>
										<li class="related-post">
											<a href="/aspdotnet-dependency-inject-a-background-service-into-the-controllers/">C# &#8211; Dependency inject BackgroundService into controllers</a>
										</li>
										<li class="related-post">
											<a href="/aspnetcore-control-the-graceful-shutdown-time-for-background-services/">ASP.NET Core &#8211; Control the graceful shutdown time for background services</a>
										</li>
										<li class="related-post">
											<a href="/csharp-how-to-batch-read-with-threading-channelreader/">C# &#8211; How to batch read with Threading.ChannelReader</a>
										</li>
										<li class="related-post">
											<a href="/how-to-use-nlog-in-aspdotnet/">How to use NLog in ASP.NET</a>
										</li>
									</ul>
									<div style="clear:both;"></div>
</div>
							</div>

				<footer class="entry-meta" aria-label="Entry meta">
			<span class="cat-links"><span class="gp-icon icon-categories"><svg viewbox="0 0 512 512" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"><path d="M0 112c0-26.51 21.49-48 48-48h110.014a48 48 0 0143.592 27.907l12.349 26.791A16 16 0 00228.486 128H464c26.51 0 48 21.49 48 48v224c0 26.51-21.49 48-48 48H48c-26.51 0-48-21.49-48-48V112z"></path></svg></span><span class="screen-reader-text">Categories </span><a href="/category/csharp/" rel="category tag">C#</a></span> <span class="tags-links"><span class="gp-icon icon-tags"><svg viewbox="0 0 512 512" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"><path d="M20 39.5c-8.836 0-16 7.163-16 16v176c0 4.243 1.686 8.313 4.687 11.314l224 224c6.248 6.248 16.378 6.248 22.626 0l176-176c6.244-6.244 6.25-16.364.013-22.615l-223.5-224A15.999 15.999 0 00196.5 39.5H20zm56 96c0-13.255 10.745-24 24-24s24 10.745 24 24-10.745 24-24 24-24-10.745-24-24z"></path><path d="M259.515 43.015c4.686-4.687 12.284-4.687 16.97 0l228 228c4.686 4.686 4.686 12.284 0 16.97l-180 180c-4.686 4.687-12.284 4.687-16.97 0-4.686-4.686-4.686-12.284 0-16.97L479.029 279.5 259.515 59.985c-4.686-4.686-4.686-12.284 0-16.97z"></path></svg></span><span class="screen-reader-text">Tags </span><a href="/tag/addhostedservice/" rel="tag">addhostedservice</a>, <a href="/tag/addsingleton/" rel="tag">addsingleton</a>, <a href="/tag/appsettings-json/" rel="tag">appsettings.json</a>, <a href="/tag/aspnetcore/" rel="tag">aspnetcore</a>, <a href="/tag/await/" rel="tag">await</a>, <a href="/tag/backgroundservice/" rel="tag">backgroundservice</a>, <a href="/tag/const/" rel="tag">const</a>, <a href="/tag/consumer-producer/" rel="tag">consumer-producer</a>, <a href="/tag/datatable/" rel="tag">datatable</a>, <a href="/tag/datetime-now/" rel="tag">datetime-now</a>, <a href="/tag/dbnull/" rel="tag">dbnull</a>, <a href="/tag/for-loop/" rel="tag">for-loop</a>, <a href="/tag/hashset/" rel="tag">hashset</a>, <a href="/tag/httpclient/" rel="tag">httpclient</a>, <a href="/tag/httpclient-getasync/" rel="tag">httpclient-getasync</a>, <a href="/tag/interface/" rel="tag">interface</a>, <a href="/tag/logging/" rel="tag">logging</a>, <a href="/tag/manualreseteventslim/" rel="tag">manualreseteventslim</a>, <a href="/tag/nameof/" rel="tag">nameof</a>, <a href="/tag/readonly/" rel="tag">readonly</a>, <a href="/tag/sqlbulkcopy/" rel="tag">sqlbulkcopy</a>, <a href="/tag/task-delay/" rel="tag">task-delay</a>, <a href="/tag/taskcanceledexception/" rel="tag">taskcanceledexception</a>, <a href="/tag/threading-channel/" rel="tag">threading-channel</a>, <a href="/tag/try-catch/" rel="tag">try-catch</a>, <a href="/tag/typeof/" rel="tag">typeof</a>, <a href="/tag/while-loop/" rel="tag">while-loop</a></span> 		<nav id="nav-below" class="post-navigation" aria-label="Posts">
			<div class="nav-previous">
<span class="gp-icon icon-arrow-left"><svg viewbox="0 0 192 512" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M178.425 138.212c0 2.265-1.133 4.813-2.832 6.512L64.276 256.001l111.317 111.277c1.7 1.7 2.832 4.247 2.832 6.513 0 2.265-1.133 4.813-2.832 6.512L161.43 394.46c-1.7 1.7-4.249 2.832-6.514 2.832-2.266 0-4.816-1.133-6.515-2.832L16.407 262.514c-1.699-1.7-2.832-4.248-2.832-6.513 0-2.265 1.133-4.813 2.832-6.512l131.994-131.947c1.7-1.699 4.249-2.831 6.515-2.831 2.265 0 4.815 1.132 6.514 2.831l14.163 14.157c1.7 1.7 2.832 3.965 2.832 6.513z" fill-rule="nonzero"></path></svg></span><span class="prev"><a href="/csharp-user-secrets-arent-being-loaded-when-youre-using-generateassemblyinfofalse/" rel="prev">User Secrets not working due to missing UserSecretsIdAttribute</a></span>
</div>
<div class="nav-next">
<span class="gp-icon icon-arrow-right"><svg viewbox="0 0 192 512" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M178.425 256.001c0 2.266-1.133 4.815-2.832 6.515L43.599 394.509c-1.7 1.7-4.248 2.833-6.514 2.833s-4.816-1.133-6.515-2.833l-14.163-14.162c-1.699-1.7-2.832-3.966-2.832-6.515 0-2.266 1.133-4.815 2.832-6.515l111.317-111.316L16.407 144.685c-1.699-1.7-2.832-4.249-2.832-6.515s1.133-4.815 2.832-6.515l14.163-14.162c1.7-1.7 4.249-2.833 6.515-2.833s4.815 1.133 6.514 2.833l131.994 131.993c1.7 1.7 2.832 4.249 2.832 6.515z" fill-rule="nonzero"></path></svg></span><span class="next"><a href="/csharp-how-to-use-table-valued-parameters-tvp-with-ado-net-dapper-and-ef-core/" rel="next">C# &#8211; Table-valued parameters (TVP) with Dapper</a></span>
</div>		</nav>
				</footer>
			</div>
</article>

			<div class="comments-area">
				<div id="comments">

	<h3 class="comments-title">10 thoughts on &ldquo;Logging to the database with ASP.NET Core&rdquo;</h3>
		<ol class="comment-list">
			
		<li id="comment-42681" class="comment even thread-even depth-1 parent">
			<article class="comment-body" id="div-comment-42681" itemtype="https://schema.org/Comment" itemscope>
				<footer class="comment-meta" aria-label="Comment meta">
										<div class="comment-author-info">
						<div class="comment-author vcard" itemprop="author" itemtype="https://schema.org/Person" itemscope>
							<cite itemprop="name" class="fn">Johnatan</cite>						</div>

													<div class="entry-meta comment-metadata">
								<a href="/aspdotnet-log-messages-to-the-database-in-the-background/#comment-42681">									<time datetime="2022-11-07T11:31:34-05:00" itemprop="datePublished">
										11/07/2022 at 11:31 am									</time>
								</a>							</div>
												</div>

									</footer>

				<div class="comment-content" itemprop="text">
					<p>Thanks! I come to this &#8220;problem&#8221; today (&#8216;When logging to SQL Server, don‚Äôt do so directly. &#8216;), and I was trying to do what you do!, very useful</p>
				</div>
			</article>
			<ul class="children">

		<li id="comment-42682" class="comment byuser comment-author-mak bypostauthor odd alt depth-2">
			<article class="comment-body" id="div-comment-42682" itemtype="https://schema.org/Comment" itemscope>
				<footer class="comment-meta" aria-label="Comment meta">
										<div class="comment-author-info">
						<div class="comment-author vcard" itemprop="author" itemtype="https://schema.org/Person" itemscope>
							<cite itemprop="name" class="fn">Maclain Wiltzer</cite>						</div>

													<div class="entry-meta comment-metadata">
								<a href="/aspdotnet-log-messages-to-the-database-in-the-background/#comment-42682">									<time datetime="2022-11-07T11:34:02-05:00" itemprop="datePublished">
										11/07/2022 at 11:34 am									</time>
								</a>							</div>
												</div>

									</footer>

				<div class="comment-content" itemprop="text">
					<p>You&#8217;re welcome, Johnatan. I&#8217;m glad this helped.</p>
				</div>
			</article>
			</li>
<!-- #comment-## -->
</ul>
<!-- .children -->
</li>
<!-- #comment-## -->

		<li id="comment-47904" class="comment even thread-odd thread-alt depth-1 parent">
			<article class="comment-body" id="div-comment-47904" itemtype="https://schema.org/Comment" itemscope>
				<footer class="comment-meta" aria-label="Comment meta">
										<div class="comment-author-info">
						<div class="comment-author vcard" itemprop="author" itemtype="https://schema.org/Person" itemscope>
							<cite itemprop="name" class="fn">Raj</cite>						</div>

													<div class="entry-meta comment-metadata">
								<a href="/aspdotnet-log-messages-to-the-database-in-the-background/#comment-47904">									<time datetime="2022-11-29T17:00:34-05:00" itemprop="datePublished">
										11/29/2022 at 5:00 pm									</time>
								</a>							</div>
												</div>

									</footer>

				<div class="comment-content" itemprop="text">
					<p>Thanks for the detailed article. It helped me understand so many concepts on different levels. Have few follow-up questions though.</p>
<p>What would happen if the main thread ends before background worker processed all the messages in queue? Do we lose those messages? </p>
<p>If somebody sends a cancel request, how do we ensure all the messages that are in queue sent to the database before the While loop on line 23 in DatabaseLoggerService exits? There could be another batch of messages in the queue and while loop could exit because of the cancellation request sent by main thread by calling dispose() or when it comes to the end of application.</p>
<p>Also, with an in-memory queue, will the order of the log messages preserved?</p>
<p>Thank you in advance so much!</p>
				</div>
			</article>
			<ul class="children">

		<li id="comment-48062" class="comment byuser comment-author-mak bypostauthor odd alt depth-2">
			<article class="comment-body" id="div-comment-48062" itemtype="https://schema.org/Comment" itemscope>
				<footer class="comment-meta" aria-label="Comment meta">
										<div class="comment-author-info">
						<div class="comment-author vcard" itemprop="author" itemtype="https://schema.org/Person" itemscope>
							<cite itemprop="name" class="fn">Maclain Wiltzer</cite>						</div>

													<div class="entry-meta comment-metadata">
								<a href="/aspdotnet-log-messages-to-the-database-in-the-background/#comment-48062">									<time datetime="2022-11-30T16:13:10-05:00" itemprop="datePublished">
										11/30/2022 at 4:13 pm									</time>
								</a>							</div>
												</div>

									</footer>

				<div class="comment-content" itemprop="text">
					<p>Hi Raj,</p>
<p>I&#8217;m glad this helped you. I&#8217;ll answer your questions below.</p>
<p><strong>Question 1 &#8211; &#8220;What would happen if the main thread ends before background worker processed all the messages in queue?&#8221;</strong></p>
<p>When the process starts a graceful shutdown, it calls the background service&#8217;s StopAsync(). This gives you a chance to do a graceful shutdown. In this case, you can process ALL remaining messages on the queue and then stop the ExecuteAsync() loop.</p>
<p>a. By default, you have 5 seconds to do a graceful shutdown. Extend this by adding this to the initialization logic (configure however much time you want):</p>
<p>services.Configure&lt;HostOptions&gt;(opts =&gt; opts.ShutdownTimeout = TimeSpan.FromMinutes(1));</p>
<p>b. In StopAsync(), here&#8217;s an example of how you process ALL remaining messages and insert them (instead of processing them in batches)</p>
<p>public async override Task StopAsync(CancellationToken cancellationToken)<br>
{<br>
&nbsp;&nbsp;&nbsp;&nbsp;try<br>
&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Stops new messages from being enqueued. Any attempts will results in InvalidOperationException<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Assume no new logging will happen after graceful shutdown is started<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logMessageQueue.Writer.Complete();</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Get all remaining log messages from the queue and bulk insert them all<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var allRemainingLogMessages = new List&lt;LogMessage&gt;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (logMessageQueue.Reader.TryRead(out LogMessage item))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allRemainingLogMessages.Add(item);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(&quot;Inserting all remaining log messages&quot;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;await LogRepository.Insert(allRemainingLogMessages);<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;finally<br>
&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Cancels stoppingToken (so the ExecuteAsync() loop will stop after in-progress work is completed)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;await base.StopAsync(cancellationToken);<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
}</p>
<p>When base.StopAsync() is called, it cancels the stoppingToken, which stops the ExecuteAsync() loop. If there&#8217;s any in-progress batch being processed, it will complete (stoppingToken is only used when waiting for new items on the queue, and after a batch is processed) and then exit the loop.</p>
<p><strong>Question 2 &#8211; &#8220;Do we lose those messages?&#8221;</strong></p>
<p>According to Microsoft documentation, it&#8217;s possible for the process to be shutdown unexpectedly and not do a graceful shutdown. In that case, you&#8217;d definitely lose in-progress work (the log messages).</p>
<p><strong>Question 3 &#8211; &#8220;With an in-memory queue, will the order of the log messages preserved?&#8221;</strong></p>
<p>No, but that&#8217;s what the log timestamp is for. You can order messages by the timestamp.</p>
<p>Since there are multiple producers trying to write log messages concurrently, the order that messages actually get enqueued isn&#8217;t guarenteed. The messages are timestamped BEFORE getting enqueued though, and that happens in the producer thread when it calls LoggerService.Log(). That means the times will be correct. </p>
<p>The consumer processes messages (inserts them into the database) in queue order, but you&#8217;re probably not referring to that.</p>
				</div>
			</article>
			</li>
<!-- #comment-## -->
</ul>
<!-- .children -->
</li>
<!-- #comment-## -->

		<li id="comment-48745" class="comment even thread-even depth-1 parent">
			<article class="comment-body" id="div-comment-48745" itemtype="https://schema.org/Comment" itemscope>
				<footer class="comment-meta" aria-label="Comment meta">
										<div class="comment-author-info">
						<div class="comment-author vcard" itemprop="author" itemtype="https://schema.org/Person" itemscope>
							<cite itemprop="name" class="fn">Raj</cite>						</div>

													<div class="entry-meta comment-metadata">
								<a href="/aspdotnet-log-messages-to-the-database-in-the-background/#comment-48745">									<time datetime="2022-12-06T19:12:18-05:00" itemprop="datePublished">
										12/06/2022 at 7:12 pm									</time>
								</a>							</div>
												</div>

									</footer>

				<div class="comment-content" itemprop="text">
					<p>Thank you, Mak for your prompt and detailed response.</p>
<p>I assume this background service can be put in a library and distribute as nuget pacakge so that multiple applications (ASP .NET, .Net 6) can use this library to log messages to a centralized location.</p>
				</div>
			</article>
			<ul class="children">

		<li id="comment-48764" class="comment byuser comment-author-mak bypostauthor odd alt depth-2 parent">
			<article class="comment-body" id="div-comment-48764" itemtype="https://schema.org/Comment" itemscope>
				<footer class="comment-meta" aria-label="Comment meta">
										<div class="comment-author-info">
						<div class="comment-author vcard" itemprop="author" itemtype="https://schema.org/Person" itemscope>
							<cite itemprop="name" class="fn">Maclain Wiltzer</cite>						</div>

													<div class="entry-meta comment-metadata">
								<a href="/aspdotnet-log-messages-to-the-database-in-the-background/#comment-48764">									<time datetime="2022-12-07T10:02:13-05:00" itemprop="datePublished">
										12/07/2022 at 10:02 am									</time>
								</a>							</div>
												</div>

									</footer>

				<div class="comment-content" itemprop="text">
					<p>You&#8217;re welcome! Yes, this could be generalized and put into a reusable library.</p>
				</div>
			</article>
			<ul class="children">

		<li id="comment-48769" class="comment even depth-3 parent">
			<article class="comment-body" id="div-comment-48769" itemtype="https://schema.org/Comment" itemscope>
				<footer class="comment-meta" aria-label="Comment meta">
										<div class="comment-author-info">
						<div class="comment-author vcard" itemprop="author" itemtype="https://schema.org/Person" itemscope>
							<cite itemprop="name" class="fn">Raj</cite>						</div>

													<div class="entry-meta comment-metadata">
								<a href="/aspdotnet-log-messages-to-the-database-in-the-background/#comment-48769">									<time datetime="2022-12-07T15:52:11-05:00" itemprop="datePublished">
										12/07/2022 at 3:52 pm									</time>
								</a>							</div>
												</div>

									</footer>

				<div class="comment-content" itemprop="text">
					<p>Do you think using background service should be a go-to approach to deal with this pattern?<br>
I can also use a background thread(Task.Run(ProcessLogMessage)) to process the log messages from queue. </p>
<p>What are your thoughts on both the approaches? which one do you prefer?</p>
<p>void ProcessLogMessages()<br>
{<br>
///retrieve data from queue and send it to destination<br>
}</p>
				</div>
			</article>
			<ul class="children">

		<li id="comment-48795" class="comment byuser comment-author-mak bypostauthor odd alt depth-4 parent">
			<article class="comment-body" id="div-comment-48795" itemtype="https://schema.org/Comment" itemscope>
				<footer class="comment-meta" aria-label="Comment meta">
										<div class="comment-author-info">
						<div class="comment-author vcard" itemprop="author" itemtype="https://schema.org/Person" itemscope>
							<cite itemprop="name" class="fn">Maclain Wiltzer</cite>						</div>

													<div class="entry-meta comment-metadata">
								<a href="/aspdotnet-log-messages-to-the-database-in-the-background/#comment-48795">									<time datetime="2022-12-08T16:12:11-05:00" itemprop="datePublished">
										12/08/2022 at 4:12 pm									</time>
								</a>							</div>
												</div>

									</footer>

				<div class="comment-content" itemprop="text">
					<p>Yes, I believe the background service is the way to go. There&#8217;s one queue consumer and it waits for work in a non-blocking manner.</p>
<p>Let&#8217;s discuss the other approach you mentioned. First, I&#8217;m assuming there&#8217;s an in-memory queue that everything has access to. My main question is when and where are you calling Task.Run(ProcessLogMessage)? Are you going to allow multiple queue consumers to run at once, and how many? Worst case, it&#8217;s uncontrolled, and you end up with N queue consumers all processing 1 messages at once. That eliminates the benefit of batching up the messages and doing bulk insertions. It&#8217;s practically the same as executing N number of insertions &#8211; which quickly degrades performance. On the other hand, let&#8217;s say you only want to allow one queue consumer at a time. Worst case, you have N number of fire-and-forget tasks all waiting at a lock. Those threads are being wasted. </p>
<p>With the background service, no threads are being wasted. It&#8217;s doing a non-blocking wait for work. Furthermore, it maximizes the benefits of doing bulk insertions (stated differently, it minimizes the degrading effects of doing many individual inserts).</p>
				</div>
			</article>
			<ul class="children">

		<li id="comment-49105" class="comment even depth-5 parent">
			<article class="comment-body" id="div-comment-49105" itemtype="https://schema.org/Comment" itemscope>
				<footer class="comment-meta" aria-label="Comment meta">
										<div class="comment-author-info">
						<div class="comment-author vcard" itemprop="author" itemtype="https://schema.org/Person" itemscope>
							<cite itemprop="name" class="fn">Raj</cite>						</div>

													<div class="entry-meta comment-metadata">
								<a href="/aspdotnet-log-messages-to-the-database-in-the-background/#comment-49105">									<time datetime="2023-01-04T01:12:37-05:00" itemprop="datePublished">
										01/04/2023 at 1:12 am									</time>
								</a>							</div>
												</div>

									</footer>

				<div class="comment-content" itemprop="text">
					<p>Thank you again for the details. </p>
<p>Yes, the idea is to create a library with a custom logging service. This service holds the logic of in-memory queue creation and kicking of background thread. Applications consuming the library will have the ability to register the logging service into the DI container during the start up process. At the time of registration, we will kick-off the background thread that will look for the messages in the queue. Before the main thread finishes, we will call .wait() on the background which is a blocking call(i know it is not good to use) so that all the remaining messages in the queue are processed. Could not think of better way to handle &#8211; &#8220;what if the main thread ends before background thread processed all the messages in queue&#8221; scenario.</p>
<p>Please let me know your feedback on this approach. I agree your solution is much cleaner one.</p>
<p>Thanks again!</p>
				</div>
			</article>
			</li>
<!-- #comment-## -->

		<li id="comment-49110" class="comment byuser comment-author-mak bypostauthor odd alt depth-5">
			<article class="comment-body" id="div-comment-49110" itemtype="https://schema.org/Comment" itemscope>
				<footer class="comment-meta" aria-label="Comment meta">
										<div class="comment-author-info">
						<div class="comment-author vcard" itemprop="author" itemtype="https://schema.org/Person" itemscope>
							<cite itemprop="name" class="fn">Maclain Wiltzer</cite>						</div>

													<div class="entry-meta comment-metadata">
								<a href="/aspdotnet-log-messages-to-the-database-in-the-background/#comment-49110">									<time datetime="2023-01-04T09:38:51-05:00" itemprop="datePublished">
										01/04/2023 at 9:38 am									</time>
								</a>							</div>
												</div>

									</footer>

				<div class="comment-content" itemprop="text">
					<p>Hey Raj,</p>
<p>I like your idea for putting this in a library. </p>
<p>Regarding controlling the shutdown, you can do what you&#8217;re saying from within the background service itself. Override StopAsync() and finish the work (see code in one my replies above). I&#8217;d suggest doing it through this supported approach to be on the safe side. In a previous reply, I mentioned that you have a set amount of time to perform the shutdown, but that was old behavior that&#8217;s changed now, and you have total control over the shutdown now. I looked deeper into this and wrote about it here: <a href="/aspnetcore-control-the-graceful-shutdown-time-for-background-services/">Control the graceful shutdown time for background services</a>.</p>
<p>By the way, if you&#8217;re interested, I could review your code when you build this (consulting). I have your email in the comments, so if you want, I can reach out to you.</p>
				</div>
			</article>
			</li>
<!-- #comment-## -->
</ul>
<!-- .children -->
</li>
<!-- #comment-## -->
</ul>
<!-- .children -->
</li>
<!-- #comment-## -->
</ul>
<!-- .children -->
</li>
<!-- #comment-## -->
</ul>
<!-- .children -->
</li>
<!-- #comment-## -->
		</ol>
<!-- .comment-list -->

			
	
</div>
<!-- #comments -->
			</div>

					</main>
	</div>

	<div class="widget-area sidebar is-right-sidebar grid-25 tablet-grid-25 grid-parent" id="right-sidebar">
	<div class="inside-right-sidebar">
		<aside id="block-19" class="widget inner-padding widget_block"><div></div></aside>	</div>
</div>

	</div>
</div>


<div class="site-footer footer-bar-active footer-bar-align-right">
			<footer class="site-info" aria-label="Site" itemtype="https://schema.org/WPFooter" itemscope>
			<div class="inside-site-info grid-container grid-parent">
						<div class="footer-bar">
			<aside id="block-11" class="widget inner-padding widget_block"></aside><aside id="block-7" class="widget inner-padding widget_block"><a href="/about/">About</a> ‚Ä¢ <a href="/privacy-policy/">Privacy Policy</a></aside>		</div>
						<div class="copyright-bar">
					<span class="copyright">&copy; 2025 makolyte</span></div>
			</div>
		</footer>
		</div>

<script id="generate-a11y">!function(){"use strict";if("querySelector"in document&&"addEventListener"in window){var e=document.body;e.addEventListener("mousedown",function(){e.classList.add("using-mouse")}),e.addEventListener("keydown",function(){e.classList.remove("using-mouse")})}}();</script><!--[if lte IE 11]>
<script src="/wp-content/themes/generatepress/assets/js/classList.min.js?ver=3.3.1" id="generate-classlist-js"></script>
<![endif]-->
<script id="generate-menu-js-extra">var generatepressMenu = {"toggleOpenedSubMenus":"1","openSubMenuLabel":"Open Sub-Menu","closeSubMenuLabel":"Close Sub-Menu"};</script>
<script src="/wp-content/themes/generatepress/assets/js/menu.min.js?ver=3.3.1" id="generate-menu-js"></script>
<script id="generate-navigation-search-js-extra">var generatepressNavSearch = {"open":"Open Search Bar","close":"Close Search Bar"};</script>
<script src="/wp-content/themes/generatepress/assets/js/navigation-search.min.js?ver=3.3.1" id="generate-navigation-search-js"></script>
<script src="/wp-includes/js/comment-reply.min.js?ver=6.7.2" id="comment-reply-js" async data-wp-strategy="async"></script>

</body>


<!-- plugin=object-cache-pro client=phpredis metric#hits=1724 metric#misses=50 metric#hit-ratio=97.2 metric#bytes=835731 metric#prefetches=0 metric#store-reads=117 metric#store-writes=18 metric#store-hits=136 metric#store-misses=46 metric#sql-queries=22 metric#ms-total=400.00 metric#ms-cache=36.82 metric#ms-cache-avg=0.2748 metric#ms-cache-ratio=9.2 -->
</html>